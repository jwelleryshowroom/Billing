rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // -----------------------------------------------------------------
    // üõ°Ô∏è SECURITY MODEL v4: Role-Based & Multi-Tenant
    // -----------------------------------------------------------------

    function isAuthenticated() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return isAuthenticated() && request.auth.token.email.lower() == 'msdhrsah@gmail.com';
    }

    // Helper to get user authorization data
    function getAuth(email) {
      return get(/databases/$(database)/documents/authorized_users/$(email)).data;
    }

    function hasAuth(email) {
      return exists(/databases/$(database)/documents/authorized_users/$(email));
    }


    // Is the user a member of this business?
    function isMember(bizId) {
      return isAuthenticated() && (
        isSuperAdmin() || 
        (hasAuth(request.auth.token.email.lower()) && 
         getAuth(request.auth.token.email.lower()).businessId == bizId)
      );
    }

    // Is the user an admin for this business?
    function isBizAdmin(bizId) {
      return isAuthenticated() && (
        isSuperAdmin() || 
        (hasAuth(request.auth.token.email.lower()) && 
         getAuth(request.auth.token.email.lower()).businessId == bizId && 
         getAuth(request.auth.token.email.lower()).role == 'admin')
      );
    }

    // Is the user staff or admin for this business?
    function isStaff(bizId) {
      return isAuthenticated() && (
        isSuperAdmin() || 
        (hasAuth(request.auth.token.email.lower()) && 
         getAuth(request.auth.token.email.lower()).businessId == bizId && 
         (getAuth(request.auth.token.email.lower()).role == 'admin' || getAuth(request.auth.token.email.lower()).role == 'staff'))
      );
    }

    // -----------------------------------------------------------------
    // COLLECTION RULES
    // -----------------------------------------------------------------

    // 1. Authorized Users
    match /authorized_users/{email} {
      // NOTE: Clients must access this collection using lowercase email IDs
      allow read: if isAuthenticated() && (isSuperAdmin() || request.auth.token.email.lower() == email.lower() || isMember(getAuth(email).businessId));
      allow write: if isSuperAdmin() || (isAuthenticated() && hasAuth(request.auth.token.email.lower()) && getAuth(request.auth.token.email.lower()).role == 'admin' && request.resource.data.businessId == getAuth(request.auth.token.email.lower()).businessId);
    }

    // 2. Businesses & Nested Subcollections
    match /businesses/{bizId} {
      allow read: if isMember(bizId);
      allow write: if isSuperAdmin() || isBizAdmin(bizId);
      
      // Nested Transactions
      match /transactions/{tId} {
        allow read: if true; // Public access for invoice links
        allow create: if isStaff(bizId);
        allow update: if isStaff(bizId);
        allow delete: if isBizAdmin(bizId);
      }

      // Nested Inventory
      match /inventory_items/{iId} {
        allow read: if isMember(bizId);
        allow create: if isStaff(bizId);
        allow update: if isStaff(bizId);
        allow delete: if isBizAdmin(bizId);
      }

      // Nested Customers
      match /customers/{cId} {
        allow read: if isMember(bizId);
        allow create: if isStaff(bizId);
        allow update: if isStaff(bizId);
        allow delete: if isBizAdmin(bizId);
      }
    }

    // 3. Root-Level Transactions (Legacy/Migration Support)
    match /transactions/{id} {
      allow read: if true; // Public access for invoice links
      allow create: if isStaff(request.resource.data.businessId);
      allow update: if isStaff(resource.data.businessId);
      allow delete: if isBizAdmin(resource.data.businessId);
    }

    // 4. Root-Level Inventory Items (Legacy/Migration Support)
    match /inventory_items/{id} {
      allow read: if isMember(resource.data.businessId);
      allow create: if isStaff(request.resource.data.businessId);
      allow update: if isStaff(resource.data.businessId);
      allow delete: if isBizAdmin(resource.data.businessId);
    }

    // 5. Root-Level Customers (Legacy/Migration Support)
    match /customers/{id} {
      allow read: if isMember(resource.data.businessId);
      allow create: if isStaff(request.resource.data.businessId);
      allow update: if isStaff(resource.data.businessId);
      allow delete: if isBizAdmin(resource.data.businessId);
    }

    // 6. Business Requests (Public/SA)
    match /business_requests/{requestId} {
      allow create: if isAuthenticated();
      allow read, write: if isSuperAdmin();
    }

    // 7. Error Logs
    match /error_logs/{logId} {
      allow create: if isAuthenticated();
      allow read: if isSuperAdmin();
    }
  }
}
